# 论文

## 绪论

## 相关技术介绍

### MQTT

MQTT全称是Message Queue Telemetry Transport(消息队列遥测传输), 是一个基于订阅/发布范式的消息协议，最早由IBM提出，是为了使物联网设备在复杂网络环境下的进行稳定通信而设计的协议。MQTT协议目前已经成为ISO标准(ISO / IEC 20922 PRF)。由于MQTT协议开放的特点，已经有多种语言实现了MQTT协议，其中最为著名的就是Eclipse Paho Project，提供了C/C++、Java、Python、JavaScript、Go等主流语言的实现。MQTT应用场景十分广泛，包括遥感数据、汽车、智能家居、智慧城市等。运用MQTT协议，物联网设备可以非常方便将数据发往云端，在服务器完成数据处理的工作。

#### MQTT协议的特点

##### 发布/订阅模式

在Machine-to-Machine(机器之间)的通讯中，传统的请求/响应模式不再适用，取而代之的是发布/订阅模式。在请求/响应模式中，发送请求的客户与发送响应的客户是一种同步关系，就好像打电话一样，需要一直等到对方接电话了才能够开始交流；在发布/订阅模式中，消息的发布者与订阅者之间是异步的关系，这意味着发布者和订阅者之间不需要建立直接的联系，就好像发邮件一样，什么时候发邮件都行，等收件人有空去查看邮件就行了。

##### 主题

MQTT通过主题Topic对消息进行分类，消息的发布者和订阅者必须指定感兴趣的主题。主题本质就是一个字符串，类似文件路径，通过反斜杠表示多个层级关系。
消息的发布者和订阅者可以使用通配符来订阅某一类消息，其中+表示过滤一个层级，#只能出现在主题的最后表示过滤任意级别的层级。例如：

- building-a/floor-1：代表A楼1层的设备
- +/floor-1：代表任何楼的1层的设备
- building-a/#：代表A楼所有的设备

##### 服务质量

MQTT被设计能够工作多种网络环境下，为了在不同网络环境下提供消息的可靠性，MQTT提供了三种不同级别的服务质量(Quality of Service, QoS)：

- Level 0：消息的发布者会尽量发送消息，但是如果消息在中途丢失，发布者不会重新发送丢失的消息。因此不能确保消息的订阅者能够收到消息。
- Level 1：消息的发布者会等待代理服务器的确认，如果发布者没有在一定时间内收到消息的确认，就会至少再发送一次未被确认的消息，直到接受到确认。因此这种方式很可能造成多次重复消息。
- Level 2：与Level 1的至少一次重发不同，如果消息的发布者没有收到对消息的确认，发布者只会再重发一次未被确认的消息，不管这次重发的消息有没有收到确认。

##### 遗嘱机制

当MQTT客户端因为网络因素等其它非正常原因导致连接断开时，用户可以启用客户端的遗嘱机制，这样在客户端断开连接时，代理服务器将以发布话题的形式告知对该客户端感兴趣的其它客户端。

#### Mosquitto代理服务器介绍

当设备之间通过MQTT协议进行通讯时，需要有中间服务器来管理不同的话题、转发消息、进行权限认证、加密消息等工作，完成这部分工作的中间件称其为MQTT代理服务器，常见的MQTT代理服务器有Mosquitto、HiveMQ、EMQ等，因为开源的Mosquitto非常方便进行二次开发，因此本论文采用的是Mosquitto作为实验的MQTT代理服务器。

##### 使用SSL/TLS加密消息

MQTT协议使用TCP协议进行传输，默认TCP协议明文传输数据，将数据直接暴露在复杂的网络环境中会带来安全隐患，数据可能会被窃取、篡改，因此对数据进行加密显得十分重要。  
SSL(Secure Sockets Layer)最初由Netscape公司设计，为网络通信提供一种数据安全以及数据完整性的协议，在传输层为网络链接进行加密。TLS(Transport Layer Security)是SSL的继任者，TLS 1.0建立在SSL 3.0的基础上。目前应用最广泛的是TLS 1.0，但是主流浏览器已经支持TLS1.2了。  
在SSL/TLS协议中：所有信息都是加密传输的，第三方无法窃听；通信双方会对信息进行校验，一旦被篡改，通信双方会立即发现；配备身份证书，防止身份被他人冒充。
在SSL/TLS握手阶段，客户端先向服务器请求公钥，然后使用公钥加密信息，服务器收到密文后，使用私钥解密。为了防止公钥被篡改，将公钥存在数字证书中，只要证书是可信的，公钥就是可信的。  
但是使用非对称加密开销太大，因此在握手阶段完成后，客户端和服务器协商生成了会话密钥，之后的通信使用会话密钥进行对称加密，非对称加密只用于握手阶段，减少了后续通信加密运算的时间。因此，SSL/TLS协议的过程大致为：

- 客户端向服务器索取公钥并进行验证
- 客户端和服务器协商生成会话密钥
- 客户端和服务器使用会话密钥对通信进行加密

Mosquitto支持对消息进行SSL/TLS加密，本论文使用的是TLS 1.0版本，对消息进行加密后，无法再传输过程中窃取篡改消息，提高了数据传输的安全性

##### 基于用户名和密码的认证

Mosquitto支持使用X509证书来进行认证，不过使用证书进行认证会带来一定的额外开销，例如需要关系证书的生命周期，并且本论文实现的系统还需要对用户进行认证，为每个用户颁发证书进行认证登录显然是不合理的。因此本论文使用的是基于用户名和密码的认证。因为Mosquitto只对用户名和密码认证提供有限的支持，不能满足本论文实现系统的要求，因此采用开源的插件mosquitto-auth-plug来实现用户名和密码认证。该插件提供对各种主流数据库的支持，并且与本论文的后台框架Django也能实现较好的融合。

### Docker

### Django

### LEP

### Mjpg-streamer

## 基于客户端开发设计与实现

## 基于服务器后台开发设计与实现

## 实验平台搭建

## 总结