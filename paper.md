# 论文

## 绪论

## 相关技术介绍

### MQTT

MQTT全称是Message Queue Telemetry Transport(消息队列遥测传输), 是一个基于订阅/发布范式的消息协议，最早由IBM提出，是为了使物联网设备在复杂网络环境下的进行稳定通信而设计的协议。MQTT协议目前已经成为ISO标准(ISO / IEC 20922 PRF)。由于MQTT协议开放的特点，已经有多种语言实现了MQTT协议，其中最为著名的就是Eclipse Paho Project，提供了C/C++、Java、Python、JavaScript、Go等主流语言的实现。MQTT应用场景十分广泛，包括遥感数据、汽车、智能家居、智慧城市等。运用MQTT协议，物联网设备可以非常方便将数据发往云端，在服务器完成数据处理的工作。

#### MQTT协议的特点

##### 发布/订阅模式

在Machine-to-Machine(机器之间)的通讯中，传统的请求/响应模式不再适用，取而代之的是发布/订阅模式。在请求/响应模式中，发送请求的客户与发送响应的客户是一种同步关系，就好像打电话一样，需要一直等到对方接电话了才能够开始交流；在发布/订阅模式中，消息的发布者与订阅者之间是异步的关系，这意味着发布者和订阅者之间不需要建立直接的联系，就好像发邮件一样，什么时候发邮件都行，等收件人有空去查看邮件就行了。

##### 主题

MQTT通过主题Topic对消息进行分类，消息的发布者和订阅者必须指定感兴趣的主题。主题本质就是一个字符串，类似文件路径，通过反斜杠表示多个层级关系。
消息的发布者和订阅者可以使用通配符来订阅某一类消息，其中+表示过滤一个层级，#只能出现在主题的最后表示过滤任意级别的层级。例如：

- building-a/floor-1：代表A楼1层的设备
- +/floor-1：代表任何楼的1层的设备
- building-a/#：代表A楼所有的设备

##### 服务质量

MQTT被设计能够工作多种网络环境下，为了在不同网络环境下提供消息的可靠性，MQTT提供了三种不同级别的服务质量(Quality of Service, QoS)：

- Level 0：消息的发布者会尽量发送消息，但是如果消息在中途丢失，发布者不会重新发送丢失的消息。因此不能确保消息的订阅者能够收到消息。
- Level 1：消息的发布者会等待代理服务器的确认，如果发布者没有在一定时间内收到消息的确认，就会至少再发送一次未被确认的消息，直到接受到确认。因此这种方式很可能造成多次重复消息。
- Level 2：与Level 1的至少一次重发不同，如果消息的发布者没有收到对消息的确认，发布者只会再重发一次未被确认的消息，不管这次重发的消息有没有收到确认。

##### 遗嘱机制

当MQTT客户端因为网络因素等其它非正常原因导致连接断开时，用户可以启用客户端的遗嘱机制，这样在客户端断开连接时，代理服务器将以发布话题的形式告知对该客户端感兴趣的其它客户端。

#### Mosquitto代理服务器介绍

当设备之间通过MQTT协议进行通讯时，需要有中间服务器来管理不同的话题、转发消息、进行权限认证、加密消息等工作，完成这部分工作的中间件称其为MQTT代理服务器，常见的MQTT代理服务器有Mosquitto、HiveMQ、EMQ等，因为开源的Mosquitto非常方便进行二次开发，因此本论文采用的是Mosquitto作为实验的MQTT代理服务器。

##### 使用SSL/TLS加密消息

MQTT协议使用TCP协议进行传输，默认TCP协议明文传输数据，将数据直接暴露在复杂的网络环境中会带来安全隐患，数据可能会被窃取、篡改，因此对数据进行加密显得十分重要。  
SSL(Secure Sockets Layer)最初由Netscape公司设计，为网络通信提供一种数据安全以及数据完整性的协议，在传输层为网络链接进行加密。TLS(Transport Layer Security)是SSL的继任者，TLS 1.0建立在SSL 3.0的基础上。目前应用最广泛的是TLS 1.0，但是主流浏览器已经支持TLS1.2了。  
在SSL/TLS协议中：所有信息都是加密传输的，第三方无法窃听；通信双方会对信息进行校验，一旦被篡改，通信双方会立即发现；配备身份证书，防止身份被他人冒充。
在SSL/TLS握手阶段，客户端先向服务器请求公钥，然后使用公钥加密信息，服务器收到密文后，使用私钥解密。为了防止公钥被篡改，将公钥存在数字证书中，只要证书是可信的，公钥就是可信的。  
但是使用非对称加密开销太大，因此在握手阶段完成后，客户端和服务器协商生成了会话密钥，之后的通信使用会话密钥进行对称加密，非对称加密只用于握手阶段，减少了后续通信加密运算的时间。因此，SSL/TLS协议的过程大致为：

- 客户端向服务器索取公钥并进行验证
- 客户端和服务器协商生成会话密钥
- 客户端和服务器使用会话密钥对通信进行加密

Mosquitto支持对消息进行SSL/TLS加密，本论文使用的是TLS 1.0版本，对消息进行加密后，无法再传输过程中窃取篡改消息，提高了数据传输的安全性

##### 基于用户名和密码的认证

Mosquitto支持使用X509证书来进行认证，不过使用证书进行认证会带来一定的额外开销，例如需要关系证书的生命周期，并且本论文实现的系统还需要对用户进行认证，为每个用户颁发证书进行认证登录显然是不合理的。因此本论文使用的是基于用户名和密码的认证。因为Mosquitto只对用户名和密码认证提供有限的支持，不能满足本论文实现系统的要求，因此采用开源的插件mosquitto-auth-plug来实现用户名和密码认证。该插件提供对各种主流数据库的支持，并且与本论文的后台框架Django也能实现较好的融合。

### Docker

软件开发过程中环境配置是一件非常麻烦的工作，不同机器有不同的环境，如何让软件在不同机器上运行起来是一件非常有挑战的事情。

#### 虚拟机技术介绍

为了实现软件带环境发布的目标，可以使用虚拟机技术。虚拟机技术通过模拟一个完整的操作系统来还原软件的运行环境，但是该方案存在以下不足之处：

- 资源占用多。虚拟机模拟的不仅仅是软件所依赖的环境配置，还有整个操作系统，因此即使真正运行的程序占用的内存只有1M，虚拟机也需要几百M的内存才能运行
- 冗余步骤多。因为虚拟机模拟的是整个操作系统，因此会带来一些与程序运行无关的额外操作，比如登录操作系统
- 启动慢。虚拟机不仅仅启动我们需要运行的程序，还会启动一系列与操作系统相关的服务，导致启动较

#### Docker技术介绍

Docker属于Linux容器的一种封装，提供简单易用的外部接口，是目前最流行的Linux容器解决方案。与虚拟机不同，Linux容器模拟的不是一个完整的操作系统，而是对不同的进程进行隔离。对于运行在容器内的进程来说，它所见的各种资源都是虚拟的，从而实现与底层系统的隔离。因为容器实现的是进程级别的虚拟化，相比传统的虚拟机技术而言，有很多优势：

- 启动速度快。一个容器对于底层操作来说就是一个进程，因此启动一个容器就是启动本机的一个进程，而不是启动一整个操作系统，因此启动速度非常快
- 资源占用少。一方面容器提供的进程级别的虚拟化，相比于虚拟机来说，不会占用不需要使用的资源；另一方面容器之间可以共享资源，但是虚拟机是独享资源
- 打包体积小。打包的容器只包含需要使用的组件，而虚拟机需要打包一整个操作系统，所以容器文件要比虚拟机占用的空间小

### Django

#### 框架介绍

Django是一个高级的Python网络框架，使用Django可以快速开发安全和可维护的网站。Django负责处理网络开发中麻烦的部分，开发者可以专注于上层应用程序的开发，无需关心底层网络通讯的细节。使用Django开发可以带来以下优点：

- 通用性。Django可以适用于开发几乎任何类型的网站，包括维基、社交网站等等。Django也可以与目前任何客户端框架一起工作，并且可以提供几乎任何格式的内容，例如HTML, RSS, JSON等等
- 安全性。默认情况下，Django可以防范许多攻击，包括SQL注入、跨网站伪造请求和点击劫持
- 可维护性。Django代码的编写遵循一定的设计原则和模式，鼓励创建可重复使用和可维护的代码。Django代码遵循不要重复自己的DRY原则，减少了不必要的重复，使得代码数量大大减少，增加了可维护性

#### 架构设计

Django采用MVT的软件设计模式，即模型Model、视图View和模板Template。三者的关系如下表：
层次|职责
---|---
Model|处理与数据有关的所有事务，包括数据的存取、数据有效性的验证
View|处理模型的存取，以及实现页面跳转的逻辑，是模板与模板之间的桥梁
Template|处理如何在页面上展示数据的问题

从上表可以看出，与传统的MVC设计模式相比，Django的视图层仅仅决定要展示哪些数据，而模板层决定要如何展示数据，可以理解为Django将传统MVC设计模式中的视图层划分为新的视图层和模板层，这样划分更具灵活性，使得可以随时替换模板层。至于传统MVC设计模式的控制器部分，在Django中由URLconf实现，URLconf使用正则表达式来匹配URL，然后调用相应的Python函数进行处理。

### LEP

LEP全称是Linux Easy Profiling(Linux易用剖析器)，是由国内嵌入式专家宋宝华和国内Linux内核专家陈莉君等人致力打造的开源项目，目的是为了便利Linux程序员，使其更加容易监控CPU的运行状态，发现程的性能瓶颈，优化程序的执行效率。Linux有很多现成的调试和剖析工具，比如top，iotop等，LEP不仅在功能上是这些传统工具的超集，而且在数据可视化，人机交互等方面对这些工具做了进一步的增强。

#### 架构设计

LEP将数据采集和数据显示分离，数据采集端对应的是LEPD(LEP Daemon)程序，数据显示端对应的是LEPV(LEP Viewer)程序。LEPD完全使用C语言程序编写，使得LEPD不仅可以部署在服务器上，也可以部署在性能相对匮乏的嵌入式板上，采用C语言编写的另一个好处是可以最小化对宿主机性能的影响，保证数据采集的准确性，能够准确反映宿主机的负载情况。LEPV使用Django作为后台网络框架，基于Docker部署，能够非常方便地进行安装。LEPD采集被监控端的数据，WEB服务端通过JSONRPC的形式获得这些原始数据，LEPV使用Python对原始数据进行加工处理，再发送给浏览器，浏览器使用JavaScript以丰富图表形式展示数据。

### mjpg-streamer

mjpg-streamer是一个命令行工具，它能够从多种不同的输入组件获取JPEG帧，并将其复制到多个不同的输出组件。比较常用的输入组件包括input_opencv、input_raspicam和input_uvc；输出组件包括output_http和output_viewer。一种常见的使用方式是使用input_uvc组件在Linux下获取支持UVC标准摄像头的JPEG图像，使用output_http组件进行输出，这样就实现了一个基本的IP Camera的功能，通过访问摄像头的IP地址就可以获取JPEG图像。mjpg-streamer只能运行在可信的网络内，因为在同一网络中的所有设备都可以访问获取到摄像头的图像信息，考虑到安全性问题，本论文实现的系统在互联网传输图像时，不是采用直接暴露摄像头地址的方式，而是利用MQTT代理服务器的加密功能，使得图像信息不被窃取。

## 基于客户端开发设计与实现

对于机器人后台管理系统而言，存在某些实时性要求较高的场景，例如遥控机器人避开障碍物，需要开发本地客户端来满足实时性要求。

### 系统概述

本地机器人客户端主要实现接收来自机器人的视频信息、读取控制手柄信息以及将控制信息发送给机器人的功能。本地客户端和机器人处于同一局域网下，通过mjpg-streamer传输视频信息，根据机器人采集的视频信息，通过手柄控制机器人运动。

### 获取视频信息

机器人上运行着mjpg-streamer服务，通过使用input_uvc组件获取USB摄像头的JPEG格式图像，使用output_http组件在机器人上开启HTTP服务器，外部可以通过访问HTTP服务器获取JPEG格式图像

#### 使用socket连接HTTP服务器

socket可以使用HTTP协议与HTTP服务器进行通信。HTTP协议是纯文本协议，意味着使用socket与服务器建立连接后，直接传递纯文本就可以了。mjpg-streamer使用output_http组件在机器人上建立了HTTP服务器，为了获取机器人采集到的视频数据，需要向HTTP服务器发送GET请求，服务器通过GET请求携带的action参数来进行不同的处理，将action参数设置为stream可以获得视频流数据。

#### 使用socket接收JPEG图像

使用socket接收JPEG图像的关键在于判断图像的起始标记和结束标记。JPEG文件内容分为两个部分：标记码和压缩数据。标记码由两个字节组成，每种标记码的第一个字节都是0xFF，后一个字节用来区分不同的标记码，SOI(Start of Image)标记码为0xFFD8，EOI(End of Image)标记码为0xFFD9。因此在socket接收到的数据中，从0xFFD8到0xFFD9之间的数据就构成一张完整JPEG图像。通过显示连续的JPEG图像就形成了视频。

### 获取手柄信息

本论文使用的手柄型号为Logitech Extreme 3D Pro，Linux内核自带手柄驱动joystick，因此可以通过读设备文件来获得手柄的输入信息，获取手柄的输入信息非常容易，但是每款手柄的按键都有自己的编码方式，加上本论文使用的手柄官方并没有给出按键的编码表，因此本论文使用的是Wisconsin Robotics公司开源的Joystick Library。Joystick Library是一个跨平台的解决方案，支持获取多款手柄的控制信息，使用起来非常方便。

## 基于服务器后台开发设计与实现

### 系统概述

基于服务器的机器人后台管理系统实现了如下功能：

- 用户管理功能。包括用户注册、登录、注销
- 机器人管理功能。包括添加删除机器人、静态地为机器人添加或删除传感器以及创建或删除传感器类型
- 数据管理功能。机器人将各种传感器信息上传到服务器后台，既可以实时可视化数据，也可以将数据保存到服务器，方便以后查看
- 远程控制机器人功能。在远程通过服务器控制机器人移动

## 实验平台搭建

## 总结